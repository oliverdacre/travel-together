{% extends "base.html" %}

{% block content %}
<div class="message-board">
  <div class="card">
    <h1>ğŸ’¬ Message Board</h1>
    <p><a href="{{ url_for('trip.detail', trip_id=trip_id) }}" class="btn btn-link">â† Back to trip details</a></p>
  </div>

  <div class="message-list" id="messageListContainer">
    <ul id="messageList">
      {% if messages %}
        {% for message in messages %}
          <li class="message-item" data-message-id="{{ message.id }}">
            <div>
              <a href="{{ url_for('profile.profile', user_id=message.user.id) }}" class="message-author">
                ğŸ‘¤ {{ message.user.name }}
              </a>
            </div>
            <div class="message-content">{{ message.content }}</div>
            {% if message.images %}
              <div class="message-images">
                {% for image in message.images %}
                  <img src="{{ url_for('main.uploaded_file', filename=image.file_path) }}" alt="image" class="message-image">
                {% endfor %}
              </div>
            {% endif %}
            <div class="message-timestamp">ğŸ•’ {{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
          </li>
        {% endfor %}
      {% else %}
        <li id="noMessages" class="no-messages">ğŸ’­ No messages yet. Be the first to post!</li>
      {% endif %}
    </ul>
  </div>

  {% if proposal.status.name in ['open', 'closed'] %}
  <div class="message-form-card">
    <form method="post" action="{{ url_for('main.post_message', trip_id=trip_id) }}" id="messageForm" enctype="multipart/form-data">
      <div class="form-group">
        <label for="message">âœï¸ Leave a Message:</label>
        <textarea id="message" name="message" rows="4" required placeholder="Type your message here..."></textarea>
        <label for="images">ğŸ“· (Optional) Attach Image(s):</label>
        <input type="file" id="images" name="images" accept="image/*" multiple>
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">ğŸ“¤ Post Message</button>
      </div>
    </form>
  </div>
  {% endif %}
</div>

<script>
    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    const tripId = {{ trip_id }};
    const pollInterval = 3000; // 3 seconds

    function fetchNewMessages() {
        $.ajax({
            url: `/trip/${tripId}/messages/since/${lastMessageId}`,
            type: 'GET',
            dataType: 'json',
            success: function(newMessages) {
                if (newMessages.length > 0) {
                    const $messageList = $('#messageList');
                    const $noMessages = $('#noMessages');
                    
                    // Remove "no messages" placeholder if it exists
                    if ($noMessages.length) {
                        $noMessages.remove();
                    }
                    
                    // Add new messages
                    $.each(newMessages, function(index, msg) {
                        const $li = $('<li>')
                            .addClass('message-item')
                            .attr('data-message-id', msg.id);
                        
                        // Create message structure
                        const $author = $('<div>')
                            .html($('<a>')
                                .attr('href', `/profile/${msg.user_id}`)
                                .addClass('message-author')
                                .text('ğŸ‘¤ ' + msg.user_name));
                        
                        const $content = $('<div>')
                            .addClass('message-content')
                            .text(msg.content);
                        
                        // Add images if present
                        let $images = null;
                        if (msg.images && msg.images.length > 0) {
                            $images = $('<div>').addClass('message-images');
                            $.each(msg.images, function(i, imagePath) {
                                const $img = $('<img>')
                                    .attr('src', imagePath)
                                    .attr('alt', 'image')
                                    .addClass('message-image');
                                $images.append($img);
                            });
                        }
                        
                        const $timestamp = $('<div>')
                            .addClass('message-timestamp')
                            .text('ğŸ•’ ' + msg.timestamp);
                        
                        $li.append($author)
                           .append($content);
                        
                        if ($images) {
                            $li.append($images);
                        }
                        
                        $li.append($timestamp);
                        
                        $messageList.append($li);
                        
                        // Update lastMessageId
                        lastMessageId = Math.max(lastMessageId, msg.id);
                    });
                    
                    // Optional: Scroll to bottom
                    $messageList[0].scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            },
            error: function(error) {
                console.error('Error fetching messages:', error);
            }
        });
    }

    // Start polling
    setInterval(fetchNewMessages, pollInterval);

    // Handle form submission with AJAX (optional - prevents page reload)
    $('#messageForm').on('submit', function(event) {
        event.preventDefault();
        
        const $textarea = $('#message');
        const messageContent = $textarea.val().trim();
        const $imageInput = $('#images')[0];
        
        if (!messageContent) {
            return;
        }
        
        // Create FormData to handle file uploads
        const formData = new FormData();
        formData.append('message', messageContent);
        
        // Append all selected images
        if ($imageInput.files.length > 0) {
            for (let i = 0; i < $imageInput.files.length; i++) {
                formData.append('images', $imageInput.files[i]);
            }
        }
        
        $.ajax({
            url: `/trip/${tripId}/message_board`,
            type: 'POST',
            data: formData,
            processData: false,  // Don't process the data
            contentType: false,  // Don't set content type (let browser set it with boundary)
            success: function(response) {
                $textarea.val('');
                $imageInput.value = '';  // Clear file input
                setTimeout(fetchNewMessages, 500);
            },
            error: function(error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        });
    });
</script>
{% endblock %}