{% extends "base.html" %}

{% block content %}
{% if messages %}
    <h2>Messages:</h2>
    <ul id="messageList">
        {% for message in messages %}
            <li data-message-id="{{ message.id }}">
                <strong>{{ message.user.name }}:</strong> {{ message.content }} 
                <em>({{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }})</em>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <h2>Messages:</h2>
    <ul id="messageList">
        <li id="noMessages">No messages yet. Be the first to post!</li>
    </ul>
{% endif %}

<form method="post" action="{{ url_for('main.post_message', trip_id=trip_id) }}" id="messageForm">
    <label for="message">Leave a Message:</label><br>
    <textarea id="message" name="message" rows="4" cols="50" required></textarea><br>
    <input type="submit" value="Post Message">
</form>

<script>
    let lastMessageId = {{ messages[-1].id if messages else 0 }};
    const tripId = {{ trip_id }};
    const pollInterval = 3000; // 3 seconds

    function fetchNewMessages() {
        $.ajax({
            url: `/trip/${tripId}/messages/since/${lastMessageId}`,
            type: 'GET',
            dataType: 'json',
            success: function(newMessages) {
                if (newMessages.length > 0) {
                    const $messageList = $('#messageList');
                    const $noMessages = $('#noMessages');
                    
                    // Remove "no messages" placeholder if it exists
                    if ($noMessages.length) {
                        $noMessages.remove();
                    }
                    
                    // Add new messages
                    $.each(newMessages, function(index, msg) {
                        const $li = $('<li>')
                            .attr('data-message-id', msg.id);
                        
                        // Escape HTML for security
                        const $strong = $('<strong>').text(msg.user_name + ':');
                        const $em = $('<em>').text(`(${msg.timestamp})`);
                        
                        // Assemble the message
                        $li.append($strong)
                           .append(' ' + $('<div>').text(msg.content).html() + ' ')
                           .append($em);
                        
                        $messageList.append($li);
                        
                        // Update lastMessageId
                        lastMessageId = Math.max(lastMessageId, msg.id);
                    });
                    
                    // Optional: Scroll to bottom
                    $messageList[0].scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            },
            error: function(error) {
                console.error('Error fetching messages:', error);
            }
        });
    }

    // Start polling
    setInterval(fetchNewMessages, pollInterval);

    // Handle form submission with AJAX (optional - prevents page reload)
    $('#messageForm').on('submit', function(event) {
        event.preventDefault();
        
        const $textarea = $('#message');
        const messageContent = $textarea.val().trim();
        
        if (!messageContent) {
            return;
        }
        
        $.ajax({
            url: `/trip/${tripId}/message_board`,
            type: 'POST',
            data: { message: messageContent },
            success: function(response) {
                $textarea.val('');
                setTimeout(fetchNewMessages, 500);
            },
            error: function(error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        });
    });
</script>
{% endblock %}